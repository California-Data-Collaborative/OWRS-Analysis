---
title: "OWRS Analysis"
output: html_notebook
---

```{r, echo=FALSE}
library(dplyr)
library(ggplot2)
library(scales)
library(raster)
library(RateParser)
library(yaml)
library(purrr)
library(fuzzywuzzyR)
library(lubridate)
```


```{r, echo=FALSE}
source("R/utils.R")
source("R/plots.R")


#Declare the customer classes to be tested for each utility
customer_classes <- c("RESIDENTIAL_SINGLE"
                      #"RESIDENTIAL_MULTI",
                      #"COMMERCIAL"
)
#End

#import sample data and give the data parameters used in the owrs files that are not in the original data
df_smc <- santamonica
names(df_smc) <- c( "cust_id", "usage_ccf", "usage_month", "usage_year",  "cust_class", "usage_date", "cust_class_from-utility")

df_sample <- tbl_df(df_smc) %>%
  mutate(hhsize = 4, meter_size = '3/4"', usage_zone = 1, landscape_area = 2000,
         et_amount = 2.0, wrap_customer = "No", irr_area = 2000, carw_customer = "No",
         season = "Winter", tax_exemption = "granted", lot_size_group = 3,
         temperature_zone = "Medium", pressure_zone = 1, water_font = "city_delivered",
         area = "inside_city", water_type = "potable", rate_class = "C1",
         dwelling_units = 10, elevation_zone = 2, greater_than = "False",
         usage_indoor_budget_ccf = .3, meter_type = "compound", block = 1,
         tariff_area = 1, turbine_meter = "No", senior = "no") %>%
  group_by(cust_class)

df_adjustable_sample <- tbl_df(data.frame (usage_month = 7, days_in_period = 30,
                                           hhsize = 4, meter_size = '3/4"', usage_zone = 1, landscape_area = 2000,
                                           et_amount = 7.0, wrap_customer = "No", irr_area = 2000, 
                                           carw_customer = "No", season = "Winter", tax_exemption = "granted", 
                                           lot_size_group = 3, temperature_zone = "Medium", pressure_zone = 1, 
                                           water_font = "city_delivered", city_limits = "inside_city", 
                                           water_type = "potable", rate_class = "C1", dwelling_units = 10, 
                                           elevation_zone = 2, greater_than = "False", usage_indoor_budget_ccf = .3, 
                                           meter_type = "Turbine", block = 1, tariff_area = 1, turbine_meter = "No",
                                           senior = "no", cust_class = customer_classes[1]))

#change for The scatter plots (If start = end the process will be a lot faster if only concerned with histograms and bar/pie charts)
start <- 0;
end <- 50;
interval <- 5;
df_usage <- as.data.frame(list("usage_ccf"=1:10, "cust_class"="RESIDENTIAL_SINGLE"))
df_sample <-  left_join(df_usage, df_adjustable_sample, by="cust_class")



#Retrieve the directories and files in the directores from the Open-Water-Specification-File directory
owrs_path <- "../Open-Water-Rate-Specification/full_utility_rates/California";

#TODO insert the filename gathering functioon here
df_OWRS <- tbl_df(as.data.frame(list("filepath"=getFileNames(owrs_path)), stringsAsFactors=FALSE)) %>% 
  
  mutate(owrs_directory = map(filepath, strsplit, split="/") %>% map(c(1,1))) %>%
  
  mutate(filename = map(filepath, strsplit, split="/") %>% map(c(1,2))) %>%
  
  mutate(utility_id = map(owrs_directory, strsplit, split=" ") %>%  
                      map(1) %>%map(tail, n=1) %>%
                      map(gsub, pattern="\\D", replacement="") %>%
                      map(as.numeric)) %>%
  
  mutate(effective_date = sapply(filename, extract_date) ) %>% 
  mutate(utility_name = sapply(as.character(owrs_directory), extract_utility_name) )


df_bill <- calculate_bills_for_all_utilities(df_OWRS, df_sample, owrs_path, customer_classes)

#Format the Bill Information so that only valid data entries are presented, the decimal points are rounded, and the data is arranged by utility
df_final_bill <- tbl_df(df_bill) %>% filter(!is.na(bill)) %>%
  mutate(bill = round(as.numeric(bill), 2),
         commodity_charge = round(as.numeric(commodity_charge), 2),
         service_charge = round(service_charge, 2),
         utility_name = as.character(utility_name),
         bill_frequency = as.character(bill_frequency),
         usage_ccf = ifelse(unit_type=="kgal", 1.33681*usage_ccf, usage_ccf)) %>% 
  arrange(utility_name)
#End
```

```{r}
#library(rgdal)

#shape <- readOGR(dsn = "../Shapefiles", layer = "service_areas_cadc_with_utility_id")
#shape <- merge(shape, df_final_bill, by = "utility_id")

#setwd("../../Dropbox/CSV/")
#Output The Final Bill information to a  shapefile
#writeOGR(shape, ".", "service_areas_cadc_with_billing_info", driver="ESRI Shapefile", overwrite_layer = TRUE)
#End
#zipDemFiles <- list.files(recursive = TRUE)
#setwd("../")
#zip(zipfile = "../Dropbox/CSV/shapefileZip", files = paste("TempShapeFiles", zipDemFiles, sep = "/"))

#setwd("../../Documents/WaterRateTester/")
```

```{r}
#The usage_ccf to evaluate for the histograms and bar chart
singleTargetValue <- 10;
```

```{r}
plot_bill_frequency_piechart(df_final_bill)
```

```{r}
plot_mean_bill_pie(df_final_bill, singleTargetValue)
```



```{r}
plot_rate_type_pie(df_final_bill)
```

```{r}
plot_commodity_charges_vs_usage(df_final_bill, start, end, interval)
```

```{r}
plot_bills_vs_usage(df_final_bill, start, end, interval)
```

```{r}

png(filename='plots/boxplot_bills.png',  width = 700, height = 432, units = "px")
plot(boxplot_bills_vs_usage(df_final_bill, start, end, interval))
dev.off()

boxplot_bills_vs_usage(df_final_bill, start, end, interval)
```


meanpercentFixed <- round(mean(as.numeric(df_final_bill$percentFixed[df_final_bill$usage_ccf == singleTargetValue])), 3)


```{r}
plot_ratio_histogram(df_final_bill, singleTargetValue)
```

```{r}
plot_bill_histogram(df_final_bill, singleTargetValue)
```

# Rates x Efficiency
## Define Period of Analysis
```{r}
startmonth <- 1
startyear <- 2017
endmonth <- 12
endyear <- 2017

startdate <- as.Date(paste('01', as.character(startmonth), as.character(startyear)), "%d %m %Y")
enddate <- as.Date(paste('01', as.character(endmonth), as.character(endyear)), "%d %m %Y")
reference_period <- seq.Date(startdate, enddate, by="month")
```
## Calculate Rates
```{r}
# Rates time series

df_usage <- as.data.frame(list("usage_ccf"=15, "cust_class"="RESIDENTIAL_SINGLE"))

df_adjustable_sample <- tbl_df(data.frame (reference_date = reference_period,
                                           usage_month = month(reference_period),
                                           usage_year = year(reference_period),
                                           days_in_period = days_in_month(reference_period),
                                           hhsize = 4, meter_size = '3/4"', usage_zone = 1, landscape_area = 2000,
                                           et_amount = 7.0, wrap_customer = "No", irr_area = 2000, 
                                           carw_customer = "No", season = "Winter", tax_exemption = "granted", 
                                           lot_size_group = 3, temperature_zone = "Medium", pressure_zone = 1, 
                                           water_font = "city_delivered", city_limits = "inside_city", 
                                           water_type = "potable", rate_class = "C1", dwelling_units = 10, 
                                           elevation_zone = 2, greater_than = "False", usage_indoor_budget_ccf = .3, 
                                           meter_type = "Turbine", block = 1, tariff_area = 1, turbine_meter = "No",
                                           senior = "no", cust_class = customer_classes[1]))

df_sample <-  left_join(df_usage, df_adjustable_sample, by="cust_class")

df_bill <- calculate_bills_for_all_utilities(df_OWRS, df_sample, owrs_path, customer_classes)

df_final_bill <- tbl_df(df_bill) %>% filter(!is.na(bill)) %>%
  mutate(bill = round(as.numeric(bill), 2),
         commodity_charge = round(as.numeric(commodity_charge), 2),
         service_charge = round(service_charge, 2),
         utility_name = as.character(utility_name),
         bill_frequency = as.character(bill_frequency),
         usage_ccf = ifelse(unit_type=="kgal", 1.33681*usage_ccf, usage_ccf)) %>%
  filter(reference_date >= effective_date) %>% group_by(utility_name, reference_date) %>%
  filter(effective_date == max(effective_date)) %>%
  arrange(utility_name)

```
Example plot of rates time series:
```{r}
bill_scatter <- ggplot(df_final_bill,
                       #%>% filter(utility_name == "San Francisco Public Utilities Commission"),
                       aes(x=as.Date(reference_date), y=bill, color=utility_name)) +
    #geom_point(shape=1) +
    geom_line()  +
    labs(x = "report reference date", y = "Total Bill (Dollars)", color = "Utility") +
    ggtitle("Total Bill each month for 15 CCF")+
    theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 25),
          legend.position = "none")

png(filename='plots/bill_scatter.png',  width = 700, height = 432, units = "px")
plot(bill_scatter)
dev.off()

plot(bill_scatter)
```


## Calculate Efficiency
Load suppliers report info and join with the Utilities list from the OWRS files
```{r}
#load supplier reports, geoinformation and pwsid_record
supplier_reports <- read.csv('data/supplier_report.csv', stringsAsFactors=FALSE)
#supplier_geo <- read.csv('data/suppliers.csv', stringsAsFactors=FALSE)
supplier_pwsid <- read.csv('data/utilities_for_OWRS.csv', stringsAsFactors=FALSE)



# append to df_OWRS the best fuzzy match for utility_name to get pwsid
# cutoff chosen arbitraily, other values can be tested
df_OWRS$fuzzy_match <- as.character(sapply(df_OWRS$utility_name, GetCloseMatches,
                              sequence_strings = supplier_pwsid$Agency_Name, n=1L, cutoff = 0.85))

# get pswid
merged_OWRS <- merge(df_OWRS, supplier_pwsid, by.x = "fuzzy_match", by.y = "Agency_Name", all.x=TRUE, all.y=FALSE)
# merge with suplier report
merged_OWRS <- merge(merged_OWRS, supplier_reports, by.x = "PWSID", by.y = "report_pwsid", all.x=TRUE, all.y=FALSE)
```
Calculate Efficiency from the suppliers reports
```{r}
#The standard value for GPCD is assumed 55
target_gpcd <- 55
ET_adj_factor <- 0.8

merged_OWRS$production_target <- 55 * merged_OWRS$report_population * merged_OWRS$report_days_in_month +
  merged_OWRS$report_irr_area_sf * merged_OWRS$report_eto * ET_adj_factor

merged_OWRS$residential_use <- merged_OWRS$report_production_calculated * merged_OWRS$report_percent_residential

merged_OWRS$pct_above_target <- (merged_OWRS$residential_use / merged_OWRS$production_target) - 1
```

```{r}
eff_ts <- ggplot(merged_OWRS, 
                  #%>% filter(PWSID == "CA0110005"), 
                  aes(x=as.Date(report_date), y=pct_above_target, color=utility_name)) +
    #geom_point(shape=1) +
    geom_line()  +
    labs(x = "report_date", y = "Percentage above target", color = "Utility") +
    ggtitle("Efficiency Time Series")+
    theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 25),
          legend.position = "none")

png(filename='plots/eff_ts.png',  width = 700, height = 432, units = "px")
plot(eff_ts)
dev.off()

eff_ts

```


Plot GPCD (time series) Residential for each agency
```{r}
gpcd_ts <- ggplot(merged_OWRS, 
                  #%>% filter(PWSID == "CA0110005"), 
                  aes(x=as.Date(report_date), y=report_gpcd_calculated, color=utility_name)) +
    #geom_point(shape=1) +
    geom_line()  +
    labs(x = "report_date", y = "Residential GPCD (calculated)", color = "Utility") +
    ggtitle("GPCD Time Series")+
    theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 25),
          legend.position = "none")

png(filename='plots/gpcd_ts.png',  width = 700, height = 432, units = "px")
plot(gpcd_ts)
dev.off()

gpcd_ts
```
## Compare Rates and efficiency
```{r}
df_final_bill$fuzzy_match <- as.character(sapply(df_final_bill$utility_name, GetCloseMatches,
                              sequence_strings = supplier_pwsid$Agency_Name, n=1L, cutoff = 0.85))

df_final_bill <- merge(df_final_bill, supplier_pwsid, by.x = "fuzzy_match", by.y = "Agency_Name", all.x=TRUE, all.y=FALSE)


#merge on PWSID, month and Year
#df_final_bill$reference_month <- month(df_final_bill$reference_date)
#df_final_bill$reference_year <- year(df_final_bill$reference_date)
eff_vs_rate <- merge(df_final_bill, merged_OWRS, 
                     by.x = c("PWSID", "usage_month", "usage_year"),
                     by.y = c("PWSID", "report_month", "report_year"),
                     all.x=TRUE, all.y=FALSE)
```

Scatter plot of Efficiency (pct_above_target) vs Rates (Total Bill for 15 CCF)
```{r}
eff_vs_bill <- ggplot(eff_vs_rate, 
                  #%>% filter(PWSID == "CA0110005"), 
                  aes(x=bill, y=pct_above_target, color=PWSID )) +
    geom_point(shape=1) +
    #geom_line()  +
    labs(x = "Total Bill (Dollars)", y = "Percentage Above Target", color="Utility") +
    ggtitle("Efficiency vs Total bill")+
    theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 25),
          legend.position = "none")

png(filename='plots/eff_vs_bill.png',  width = 700, height = 432, units = "px")
plot(eff_vs_bill)
dev.off()

eff_vs_bill
```

Scatter plot of Efficiency vs Rates Structure (% Fixed  - for 15 CCF)
```{r}
eff_vs_pctFixed <- ggplot(eff_vs_rate, 
                  #%>% filter(PWSID == "CA0110005"), 
                  aes(x=percentFixed, y=pct_above_target, color=PWSID)) +
    geom_point(shape=1) +
    #geom_line()  +
    labs(x = "Percent of Service charge", y = "Percent above target", color = "Utility") +
    ggtitle("Efficiency vs Percent Fixed")+
    theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 25),
          legend.position = "none")

png(filename='plots/eff_vs_pctFixed.png',  width = 700, height = 432, units = "px")
plot(eff_vs_pctFixed)
dev.off()

eff_vs_pctFixed
```

