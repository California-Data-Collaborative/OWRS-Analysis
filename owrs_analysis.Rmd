---
title: "California Water Rate Survey Results 2017"
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(scales)
# library(raster)
library(RateParser)
library(yaml)
library(purrr)
library(fuzzywuzzyR)
library(lubridate)
library(captioner)
library(png)
library(grid)
library(gridExtra)
library(cowplot)
library(ggthemes)
```

# Introduction

The [California Data Collaborative ("CaDC")](http://californiadatacollaborative.org/) is a coalition of water utilities that have pioneered a new data infrastructure non-profit 501 (c) (3) to support water managers in meeting their reliability objectives and serve the public good.

One important contribution of the CaDC was to establish a standard format and to provide the infrastructure for storage and maintainance of an open database for water rates, facilitating the work of analysts, economists and software developers interested in analyzing and understanding the differences in water rate structures and prices across many different agencies and locations. The water rate structures were organized in [Open-Water-Rate-Specification (OWRS)](https://github.com/California-Data-Collaborative/Open-Water-Rate-Specification) files, a format based on [YAML](http://yaml.org/), which is designed to be easy to store, transmit, and parse in any programming language while also being easy for humans to read.

This report presents a summary of the types of analyses and insights that can be obtained from analyzing the OWRS, especially when this information is combined with the water consumption data from water agencies and Census Data.

# Data

This report provides the combined analysis of data from 4 different sources:

* Water Rates from the [Open-Water-Rates-Specification](https://github.com/California-Data-Collaborative/Open-Water-Rate-Specification).
* Water Consumption data reported by the water agencies [ADD MORE DETAIL] 
* Demographic Data from the American Community Survey [??]
* Qualitative Data from a Survey realized by the California Data Collaborative with water agencies in 2017. 

```{r, include=FALSE}
source("R/utils.R")
source("R/plots.R")
source("R/fuzzy_matching.R")

#starting function to create Figure captions
fig_nums <- captioner(prefix = "Figure")


#Declare the customer classes to be tested for each utility
customer_classes <- c("RESIDENTIAL_SINGLE"
                      #"RESIDENTIAL_MULTI",
                      #"COMMERCIAL"
)
#End


df_adjustable_sample <- tbl_df(data.frame (usage_month = 7, days_in_period = 31, usage_year=2017,
                                           hhsize = 4, meter_size = '3/4"', usage_zone = 1, landscape_area = 2000,
                                           et_amount = 7.0, wrap_customer = "No", irr_area = 2000, 
                                           carw_customer = "No", season = "Summer", tax_exemption = "granted", 
                                           lot_size_group = 3, temperature_zone = "Medium", pressure_zone = 1, 
                                           water_font = "city_delivered", city_limits = "inside_city", 
                                           water_type = "potable", rate_class = "C1", dwelling_units = 10, 
                                           elevation_zone = 2, greater_than = "False", usage_indoor_budget_ccf = .3, 
                                           meter_type = "Turbine", block = 1, tariff_area = 1, turbine_meter = "No",
                                           senior = "no", cust_class = customer_classes[1]))

#change for The scatter plots (If start = end the process will be a lot faster if only concerned with histograms and bar/pie charts)
start <- 0
end <- 50
interval <- 5
df_usage <- as.data.frame(list("usage_ccf"=seq(start,end,interval), "cust_class"="RESIDENTIAL_SINGLE"))
df_sample <-  left_join(df_usage, df_adjustable_sample, by="cust_class")

singleTargetValue <- 15

#Retrieve the directories and files in the directores from the Open-Water-Specification-File directory
owrs_path <- "../Open-Water-Rate-Specification/full_utility_rates/California";

#TODO insert the filename gathering functioon here
df_OWRS <- tbl_df(as.data.frame(list("filepath"=getFileNames(owrs_path)), stringsAsFactors=FALSE)) %>% 
  
  mutate(owrs_directory = map(filepath, strsplit, split="/") %>% map(c(1,1))) %>%
  
  mutate(filename = map(filepath, strsplit, split="/") %>% map(c(1,2))) %>%
  
  mutate(utility_id = map(owrs_directory, strsplit, split=" ") %>%  
                      map(1) %>%map(tail, n=1) %>%
                      map(gsub, pattern="\\D", replacement="") %>%
                      map(as.numeric)) %>%
  
  mutate(effective_date = as.Date(sapply(filename, extract_date)) ) %>% 
  mutate(utility_name = sapply(as.character(owrs_directory), extract_utility_name) )

df_OWRS <- df_OWRS %>% group_by(utility_name) %>% 
  arrange(desc(effective_date)) %>% 
  filter(row_number()==1)

# Join in supplier report
#load supplier reports, geoinformation and pwsid_record
supplier_reports <- read.csv('data/supplier_report.csv', stringsAsFactors=FALSE) %>%
  mutate(rgpcd = report_production_calculated*report_percent_residential/report_population/report_days_in_month)
#supplier_geo <- read.csv('data/suppliers.csv', stringsAsFactors=FALSE)
supplier_pwsid <- read.csv('data/utilities_for_OWRS.csv', stringsAsFactors=FALSE)



# append to df_OWRS the best fuzzy match for utility_name to get pwsid
# cutoff chosen arbitraily, other values can be tested
df_OWRS$utility_name_supplier_report <- as.character(sapply(df_OWRS$utility_name, GetCloseMatches,
                                              sequence_strings = supplier_pwsid$Agency_Name, n=1L, cutoff = 0.85))

owrs_to_supplier_report_manual_map <- list(
  "Big Bear Lake  City Of" = "City of Big Bear Lake, Dept of Water & Power",
  "Calaveras Public Utilities District" = "",
  "Crescent City" = "Crescent City City of",
  "Discovery Bay  Town Of" = "Discovery Bay Community Services District",
  "Golden State Water Company - Hawthorne" = "Hawthorne City of",
  "Golden State Water Company - Lakewood" = "",
  "Marina Coast Water District - Central Marina" = "Marina Coast Water District",
  "Marina Coast Water District - Ord Community" = "Marina Coast Water District",
  "Rio Dell  City Of" = "",
  "San Bernardino County Service Area 64 Spring Valley Lake" = "San Bernardino County Service Area 64",
  "Sierra Estates Mutual Water Company" = ""
)

manually_mapped_names <- as.character(owrs_to_supplier_report_manual_map[df_OWRS$utility_name])
df_OWRS$utility_name_supplier_report <- ifelse(manually_mapped_names == "NULL", 
                                               df_OWRS$utility_name_supplier_report,
                                               manually_mapped_names)

merged_OWRS <- merge(df_OWRS, supplier_pwsid, by.x = "utility_name_supplier_report", by.y = "Agency_Name", 
                     all.x=TRUE, all.y=FALSE)


# calculate bills

df_bill <- calculate_bills_for_all_utilities(merged_OWRS, supplier_reports, df_sample, owrs_path, customer_classes, singleTargetValue)

#Format the Bill Information so that only valid data entries are presented, the decimal points are rounded, and the data is arranged by utility
df_final_bill <- tbl_df(df_bill) %>% filter(!is.na(bill)) %>%
  mutate(bill = round(as.numeric(bill), 2),
         commodity_charge = round(as.numeric(commodity_charge), 2),
         service_charge = round(service_charge, 2),
         utility_name = as.character(utility_name),
         bill_frequency = as.character(bill_frequency)) %>% 
  arrange(utility_name)
#End

# Customized benchmark
df_final_bill_single <- df_final_bill %>% filter(is_single == TRUE)
df_final_bill <- df_final_bill %>% filter(is_single == FALSE)

# Global 15 CCF benchmark
# df_final_bill <- df_final_bill %>% filter(is_single == FALSE)
# df_final_bill_single <- df_final_bill %>% filter(usage_ccf == singleTargetValue)
```


```{r past_years_data, echo=FALSE}
df_past_years <- read.csv("data/raftelis_rate_surveys.csv", stringsAsFactors = FALSE)

cross_year_fixed <- df_past_years %>% 
  select(Survey.Year, Service.Area, Water.Service.Provider, Fixed.Charge) %>% 
  tidyr::spread( key=Survey.Year, value=c(Fixed.Charge), sep=".") %>% 
  arrange(Water.Service.Provider) %>%
  filter(Survey.Year.2013 != "$-")

cross_year_fixed_filtered <- cross_year_fixed %>% 
  filter(!is.na(Survey.Year.2013)&!is.na(Survey.Year.2015))


cross_year_commodity <- df_past_years %>% 
  select(Survey.Year, Service.Area, Water.Service.Provider, Commodity.Charge) %>% 
  tidyr::spread( key=Survey.Year, value=c(Commodity.Charge), sep=".") %>% 
  arrange(Water.Service.Provider) %>%
  filter(Survey.Year.2013 != "$-")

cross_year_commodity_filtered <- cross_year_commodity %>% 
  filter(!is.na(Survey.Year.2013)&!is.na(Survey.Year.2015))


cross_year_total <- df_past_years %>% 
  select(Survey.Year, Service.Area, Water.Service.Provider, Total.Charge) %>% 
  tidyr::spread( key=Survey.Year, value=c(Total.Charge), sep=".") %>% 
  arrange(Water.Service.Provider) %>%
  filter(Survey.Year.2013 != "$-")

cross_year_total_filtered <- cross_year_total %>% 
  filter(!is.na(Survey.Year.2013)&!is.na(Survey.Year.2015))



cross_year_rate_type <- df_past_years %>% 
  select(Survey.Year, Service.Area, Water.Service.Provider, Rate.Format) %>% 
  tidyr::spread( key=Survey.Year, value=c(Rate.Format), sep=".") %>% 
  arrange(Water.Service.Provider) %>%
  filter(Survey.Year.2013 != "$-")

cross_year_rate_type_filtered <- cross_year_rate_type %>% 
  filter(!is.na(Survey.Year.2013)&!is.na(Survey.Year.2015))
```

```{r, echo=FALSE}
df_past_years$utility_name_raftelis <- sapply(df_past_years$Water.Service.Provider, preprocess_raftelis_name) 
df_past_years <- assign_fuzzy_match_names(df_past_years, 
                                          source_column_name = "utility_name_raftelis",
                                          new_name_column = "utility_name_owrs",
                                          names_to_match_with = df_final_bill_single$utility_name,
                                          manual_map = NULL,
                                          cutoff = 0.85)
```



# Summary Statistics

This section discusses general characteristics of the rates for utilities analyzed in this survey.

```{r bill_frequency_pie, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px", fig.cap = bill_freq_cap }
p <- plot_bill_frequency_piechart(df_final_bill_single)

img <- "img/bill_frequency_pie.png"
ggsave(img, p)
knitr::include_graphics(img)

bill_freq_cap <- fig_nums(name='bill_frequency_piechart', caption= 'Bill Frequency Pie Chart. About three quarters of the water agencies use a monthly billing system.')

```


```{r mean_bill_by_parts_pie, echo=FALSE, message=FALSE, out.width="600px", fig.cap = mean_bill_pie_cap}
p <- plot_mean_bill_pie(df_final_bill_single)

img <- "img/mean_bill_by_parts_pie.png"
ggsave(img, p)
knitr::include_graphics(img)

mean_bill_pie_cap <- fig_nums(name='mean_bill_pie', caption= 'Average bill by parts for all agencies, considering a consumption of 10 CCF in a month. The average total bill is $60.68. With an average service charge (fixed) of $24.63 (40.6%) and an average commodity charge (variable) of $35.61 (58.7%).')
```



```{r rate_structure_type_pie, echo=FALSE, message=FALSE, out.width="600px"}
p <- plot_rate_type_pie(df_final_bill_single)

img <- "img/rate_structure_type_pie.png"
ggsave(img, p)
knitr::include_graphics(img)
```


```{r usage_histogram, echo=FALSE, message=FALSE, out.width="600px"}
p <- plot_usage_histogram(df_final_bill_single)

img <- "img/usage_histogram.png"
ggsave(img, p)
knitr::include_graphics(img)
```

Testing a different plot theme:

```{r service_charge_ratio_histogram, echo=FALSE, message=FALSE, out.width="600px"}
# meanpercentFixed <- round(mean(as.numeric(df_final_bill$percentFixed[df_final_bill$usage_ccf == singleTargetValue])), 3)


p <- plot_ratio_histogram(df_final_bill_single)

img <- "img/service_charge_ratio_histogram.png"
ggsave(img, p)
knitr::include_graphics(img)
```

```{r total_bill_histogram, echo=FALSE, message=FALSE, out.width="600px"}
p <- plot_bill_histogram(df_final_bill_single)

img <- "img/total_bill_histogram.png"
ggsave(img, p)
knitr::include_graphics(img)
```

# Variation in Bills at Different Use Levels

```{r commodity_charge_vs_usage_line, echo=FALSE, message=FALSE, out.width="600px"}

p <- plot_commodity_charges_vs_usage(df_final_bill, start, end, interval)

img <- "img/commodity_charge_vs_usage_line.png"
ggsave(img, p)
knitr::include_graphics(img)
```


```{r bill_quantiles_vs_usage, echo=FALSE, message=FALSE, out.width="600px"}
p <- plot_bill_quantiles_vs_usage(df_final_bill)

img <- "img/bill_quantiles_vs_usage.png"
ggsave(img, p)
knitr::include_graphics(img)
```


```{r, echo=FALSE}
# plot_bills_vs_usage(df_final_bill, start, end, interval)
```

```{r commodity_charge_vs_usage_boxplot, echo=FALSE, message=FALSE, out.width="600px"}

# png(filename='plots/boxplot_bills.png',  width = 700, height = 432, units = "px")
# plot(boxplot_bills_vs_usage(df_final_bill, start, end, interval))
# dev.off()

p <- boxplot_bills_vs_usage(df_final_bill, start, end, interval)

img <- "img/commodity_charge_vs_usage_boxplot.png"
ggsave(img, p)
knitr::include_graphics(img)
```




# Interaction between Rates and Efficiency
## Define Period of Analysis
Average water rates history:
```{r, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
#plot_avg_price_history(df_final_bill)
```


## Calculate Efficiency
Load suppliers report info and join with the Utilities list from the OWRS files
```{r, echo=FALSE}
# merge with suplier report
merged_OWRS <- merge(merged_OWRS, supplier_reports, by.x = "PWSID", by.y = "report_pwsid", all.x=TRUE, all.y=FALSE)

#The standard value for GPCD is assumed 55
target_gpcd <- 55
ET_adj_factor <- 0.8
unit_conversion <- 0.62

merged_OWRS$production_target <- 55 * merged_OWRS$report_population * merged_OWRS$report_days_in_month +
  merged_OWRS$report_irr_area_sf * merged_OWRS$report_eto * ET_adj_factor * unit_conversion

merged_OWRS$residential_use <- merged_OWRS$report_production_calculated * merged_OWRS$report_percent_residential

merged_OWRS$pct_above_target <- (merged_OWRS$residential_use / merged_OWRS$production_target) - 1

merged_OWRS$report_monthyear <- as.Date(paste('01', as.character(merged_OWRS$report_month),
                                              as.character(merged_OWRS$report_year)), "%d %m %Y")
```


```{r efficiency_goal_time_series_boxplot, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
p <- plot_efficiency_ts(merged_OWRS)

img <- "img/efficiency_goal_time_series_boxplot.png"
ggsave(img, p)
knitr::include_graphics(img)
```

```{r gpcd_time_series_boxplot, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
p <- plot_gpcd_ts(merged_OWRS)

img <- "img/gpcd_time_series_boxplot.png"
ggsave(img, p)
knitr::include_graphics(img)
```
## Compare Rates and efficiency
```{r, echo=FALSE}


df_final_bill_single <- assign_fuzzy_match_names(df_final_bill_single, 
                                          source_column_name = "utility_name",
                                          new_name_column = "utility_name_supplier_report",
                                           names_to_match_with = supplier_pwsid$Agency_Name,
                                           manual_map = owrs_to_supplier_report_manual_map)

# df_final_bill_single <- merge(df_final_bill_single, supplier_pwsid, by.x = "utility_name_supplier_report", by.y = "Agency_Name", all.x=TRUE, all.y=FALSE)


#merge on PWSID, month and Year
eff_vs_rate <- merge(df_final_bill_single, merged_OWRS, 
                     by.x = c("utility_name_supplier_report", "usage_month", "usage_year"),
                     by.y = c("utility_name_supplier_report", "report_month", "report_year"),
                     all.x=TRUE, all.y=FALSE)
```




```{r boxplot_bill_by_region, echo=FALSE, message=FALSE, warning=FALSE, out.width="600px"}
p <- boxplot_bill_by_region(eff_vs_rate)

img <- "img/boxplot_bill_by_region.png"
ggsave(img, p)
knitr::include_graphics(img)
```


```{r average_bill_part_by_region, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}

p <- barchart_average_charge_by_region(eff_vs_rate)

img <- "img/average_bill_part_by_region.png"
ggsave(img, p)
knitr::include_graphics(img)
```



Scatter plot of Efficiency (pct_above_target) vs Rates (Total Bill for 15 CCF)
```{r efficiency_goal_vs_total_bill_scatter_trend, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
p <- plot_eff_vs_bill(eff_vs_rate)

img <- "img/efficiency_goal_vs_total_bill_scatter_trend.png"
ggsave(img, p)
knitr::include_graphics(img)
```



## Joining Data from the Qualitative Survey
```{r, echo=FALSE, warning=FALSE}
#read the survey data in
hd <- read.csv('data/2017 CA-NV Rate Survey.csv', nrows=2, header=FALSE, stringsAsFactors = FALSE)
quali_survey <- read.csv('data/2017 CA-NV Rate Survey.csv', skip=2, header=FALSE, stringsAsFactors = FALSE)
names(quali_survey) <- paste(hd[1,], hd[2,], sep = "#")
names(quali_survey)[36] <- "costs_pct_fixed"
names(quali_survey)[37] <- "rev_pct_fixed"
names(quali_survey)[10] <- "agency_name"
names(quali_survey)[5] <- "IP_address"
names(quali_survey)[14] <- "city-town"

quali_survey$costs_pct_fixed <- as.numeric(quali_survey$costs_pct_fixed)
quali_survey$rev_pct_fixed <- as.numeric(quali_survey$rev_pct_fixed)

```

Scatter plot of Efficiency vs Rates Structure (% Fixed  - for 15 CCF)
```{r efficiency_goal_vs_percent_fixed_scatter_trend, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
agg_eff_vs_rate <- eff_vs_rate[c("PWSID", "usage_month", "usage_year",
                                 "bill", "pct_above_target")] %>% na.omit() %>%
                        group_by(PWSID) %>% summarise_all(funs(mean))

p <- plot_eff_vs_pctFixed(eff_vs_rate)# %>% filter(usage_ccf == singleTargetValue))

img <- "img/efficiency_goal_vs_percent_fixed_scatter_trend.png"
ggsave(img, p)
knitr::include_graphics(img)
```

```{r fixed_cost_percentage_histogram, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
# chart_count <- nrow(quali_survey %>% filter(!is.na(costs_pct_fixed)))
p <- ggplot(quali_survey, aes(costs_pct_fixed)) + geom_histogram(bins = 10) +
  xlab("Fixed Costs Percentage")+
  ylab("Count of Districts") +
  ggtitle("Distribution of Fixed Costs")+#, subtitle = paste(chart_count,"Districts Total"))+
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 20),
        legend.position = "none")

img <- "img/fixed_cost_percentage_histogram.png"
ggsave(img, p)
knitr::include_graphics(img)
```



```{r fixed_revenue_percentage_histogram, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
# chart_count <- nrow(quali_survey %>% filter(!is.na(rev_pct_fixed)))
p <- ggplot(quali_survey, aes(rev_pct_fixed)) + geom_histogram(bins = 10) +
  xlab("Fixed Revenue Percentage")+
  ylab("Count of Districts") +
  ggtitle("Distribution of Fixed Revenue")+#, subtitle = paste(chart_count,"Districts Total"))+
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 20),
        legend.position = "none")

img <- "img/fixed_revenue_percentage_histogram.png"
ggsave(img, p)
knitr::include_graphics(img)
```

```{r fixed_costs_vs_fixed_rev_scatter, echo=FALSE, warning=FALSE, message=FALSE, out.width="600px"}
quali_survey$fixedRev_per_fixedCosts <- quali_survey$rev_pct_fixed / quali_survey$costs_pct_fixed

# chart_count <- nrow(quali_survey %>% filter(!is.na(costs_pct_fixed)&!is.na(rev_pct_fixed)))

p <- ggplot(quali_survey, aes(x=costs_pct_fixed, y=rev_pct_fixed)) + geom_point() +
  xlab("Fixed Cost Percentage")+
  ylab("Fixed Revenue Percentage") +
  ggtitle("Fixed Revenue vs. Fixed Costs")+#, subtitle = paste(chart_count,"Districts Total"))+
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 20), title = element_text(size = 20),
        legend.position = "none")

img <- "img/fixed_costs_vs_fixed_rev_scatter.png"
ggsave(img, p)
knitr::include_graphics(img)
```


